<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Basketball Kaderanalyse</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Angepasste Schriftart */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc; /* Hellgrau */
        }
        /* Scrollbar-Stil f√ºr das Statistik-Feld */
        .stat-list::-webkit-scrollbar {
            width: 6px;
        }
        .stat-list::-webkit-scrollbar-thumb {
            background-color: #90cdf4; /* Helles Blau */
            border-radius: 3px;
        }
        .stat-list::-webkit-scrollbar-track {
            background-color: #edf2f7;
        }
        .modal-bg {
            background-color: rgba(0, 0, 0, 0.6);
        }
    </style>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, addDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = null;
        let isAuthReady = false;

        const playerListElement = document.getElementById('player-list');
        const modalElement = document.getElementById('player-modal');
        const modalTitleElement = document.getElementById('modal-title');
        const playerForm = document.getElementById('player-form');
        const statListElement = document.getElementById('stat-list');
        const statSearchInput = document.getElementById('stat-search');
        const reportContentElement = document.getElementById('report-content');
        const modalTabContainer = document.getElementById('modal-tab-container');
        const loadingIndicator = document.getElementById('loading-indicator');
        const statMessage = document.getElementById('stat-message');

        const state = {
            players: [],
            currentPlayer: null,
            currentTab: 'entry', // 'entry' or 'report'
        };

        const initialStats = {
            'PTS': 'Punkte',
            'REB': 'Rebounds',
            'AST': 'Assists',
            'STL': 'Steals',
            'BLK': 'Blocks',
            'TOV': 'Turnovers',
            'FGM': 'Feldw√ºrfe getroffen',
            'FGA': 'Feldw√ºrfe versucht',
            '3PM': 'Dreier getroffen',
            '3PA': 'Dreier versucht',
            'FTM': 'Freiw√ºrfe getroffen',
            'FTA': 'Freiw√ºrfe versucht',
            'GP': 'Gespielte Spiele',
            'MIN': 'Spielminuten',
        };
        
        // --- Utility Functions ---

        // Helper to convert base64 to ArrayBuffer (for audio) - Not needed here, but good practice to include helpers
        function base64ToArrayBuffer(base64) {
            try {
                const binaryString = atob(base64);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                return bytes.buffer;
            } catch (error) {
                console.error("Error decoding base64:", error);
                return new ArrayBuffer(0);
            }
        }

        // Helper for error/info messages in the Stat Tab
        function showStatMessage(message, type = 'info') {
            statMessage.textContent = message;
            statMessage.className = 'text-sm mt-4 p-2 rounded-lg ' + (type === 'error' ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800');
            setTimeout(() => {
                statMessage.textContent = '';
                statMessage.className = '';
            }, 3000);
        }

        // --- Analysis Logic ---

        function calculateAdvancedStats(player) {
            const s = player.stats || {};
            const PTS = s.PTS || 0;
            const REB = s.REB || 0;
            const AST = s.AST || 0;
            const STL = s.STL || 0;
            const BLK = s.BLK || 0;
            const TOV = s.TOV || 0;
            const FGM = s.FGM || 0;
            const FGA = s.FGA || 0;
            const FTM = s.FTM || 0;
            const FTA = s.FTA || 0;
            const GP = s.GP || 0;

            const format = (n) => (isFinite(n) ? n.toFixed(2) : 'N/A');

            // True Shooting Percentage (TS%)
            const TS_ATT = 2 * (FGA + 0.44 * FTA);
            const TS_PCT = (TS_ATT > 0) ? PTS / TS_ATT : 0;

            // Effective Field Goal Percentage (eFG%)
            const eFG_PCT = (FGA > 0) ? (FGM + 0.5 * (s['3PM'] || 0)) / FGA : 0;

            // Player Efficiency Rating (PER - simplified version for visualization)
            const PER_NUM = PTS + REB + AST + STL + BLK - TOV - (FGA - FGM) - (FTA - FTM);
            const PER = (GP > 0) ? PER_NUM / GP : 0;


            let reportHtml = `
                <div class="space-y-4">
                    <h3 class="text-xl font-semibold border-b pb-2 text-blue-700">Wichtige Durchschnittswerte (pro Spiel)</h3>
                    <div class="grid grid-cols-2 gap-4 text-gray-700">
                        <div class="p-3 bg-blue-50 rounded-lg shadow-sm">
                            <p class="text-sm font-medium">Punkte (PTS)</p>
                            <p class="text-2xl font-bold">${format(PTS / GP)}</p>
                        </div>
                        <div class="p-3 bg-blue-50 rounded-lg shadow-sm">
                            <p class="text-sm font-medium">Rebounds (REB)</p>
                            <p class="text-2xl font-bold">${format(REB / GP)}</p>
                        </div>
                        <div class="p-3 bg-blue-50 rounded-lg shadow-sm">
                            <p class="text-sm font-medium">Assists (AST)</p>
                            <p class="text-2xl font-bold">${format(AST / GP)}</p>
                        </div>
                        <div class="p-3 bg-blue-50 rounded-lg shadow-sm">
                            <p class="text-sm font-medium">Turnovers (TOV)</p>
                            <p class="text-2xl font-bold">${format(TOV / GP)}</p>
                        </div>
                    </div>

                    <h3 class="text-xl font-semibold border-b pt-4 pb-2 text-blue-700">Effizienz-Metriken</h3>
                    <div class="grid grid-cols-2 gap-4 text-gray-700">
                        <div class="p-3 bg-green-50 rounded-lg shadow-sm">
                            <p class="text-sm font-medium">Wahre Wurfquote (TS%)</p>
                            <p class="text-2xl font-bold">${format(TS_PCT * 100)}%</p>
                            <p class="text-xs text-gray-500">Misst die Effizienz aller W√ºrfe (Feld & Freiw√ºrfe).</p>
                        </div>
                        <div class="p-3 bg-green-50 rounded-lg shadow-sm">
                            <p class="text-sm font-medium">Effektive Feldwurfquote (eFG%)</p>
                            <p class="text-2xl font-bold">${format(eFG_PCT * 100)}%</p>
                            <p class="text-xs text-gray-500">Ber√ºcksichtigt den Wert von Dreiern.</p>
                        </div>
                        <div class="p-3 bg-yellow-50 rounded-lg shadow-sm col-span-2">
                            <p class="text-sm font-medium">Vereinfachte Effizienz (PER)</p>
                            <p class="text-2xl font-bold">${format(PER)}</p>
                            <p class="text-xs text-gray-500">Ein Ma√ü f√ºr die Gesamtleistung pro Spiel.</p>
                        </div>
                    </div>

                    <h3 class="text-xl font-semibold border-b pt-4 pb-2 text-blue-700">Wurfquoten</h3>
                    <div class="space-y-2">
                        <p class="text-lg font-medium">Feldw√ºrfe (FG): <span class="text-blue-600">${FGM} / ${FGA} (${format((FGM / FGA) * 100)}%)</span></p>
                        <p class="text-lg font-medium">Dreier (3P): <span class="text-blue-600">${s['3PM'] || 0} / ${s['3PA'] || 0} (${format(((s['3PM'] || 0) / (s['3PA'] || 0)) * 100)}%)</span></p>
                        <p class="text-lg font-medium">Freiw√ºrfe (FT): <span class="text-blue-600">${FTM} / ${FTA} (${format((FTM / FTA) * 100)}%)</span></p>
                    </div>
                </div>
            `;

            return reportHtml;
        }


        // --- Firestore & State Management ---

        function getPlayerCollectionRef() {
            if (!db || !userId) return null;
            const playerCollectionPath = `artifacts/${appId}/users/${userId}/players`;
            return collection(db, playerCollectionPath);
        }

        async function initFirebase() {
            try {
                if (!firebaseConfig) {
                    console.error("Firebase Config nicht gefunden.");
                    return;
                }
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                loadingIndicator.textContent = "Authentifizierung l√§uft...";
                
                // Sign in logic
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Wait for auth state to be ready
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        loadingIndicator.textContent = `Authentifizierung abgeschlossen. User ID: ${userId}`;
                        setTimeout(() => { loadingIndicator.classList.add('hidden'); }, 1000);
                        setupPlayerListener();
                    } else {
                        userId = null;
                        isAuthReady = true; // Still ready, just unauthenticated (though we force sign-in)
                        loadingIndicator.textContent = "Bitte melden Sie sich an.";
                    }
                });

            } catch (error) {
                console.error("Firebase Initialisierung fehlgeschlagen:", error);
                loadingIndicator.textContent = "Fehler bei der Firebase-Initialisierung. Pr√ºfen Sie die Konsole.";
            }
        }

        function setupPlayerListener() {
            if (!isAuthReady || !userId) return;

            const playersRef = getPlayerCollectionRef();
            if (!playersRef) return;

            // Real-time listener
            onSnapshot(playersRef, (snapshot) => {
                const newPlayers = [];
                snapshot.forEach(doc => {
                    newPlayers.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // Sort by jersey number (Trikotnummer)
                state.players = newPlayers.sort((a, b) => (a.number || 999) - (b.number || 999));
                renderPlayerList();
            }, (error) => {
                console.error("Fehler beim Abrufen der Spielerdaten:", error);
            });
        }
        
        async function savePlayer(playerData) {
            if (!isAuthReady || !userId) {
                console.error("Nicht authentifiziert. Speichern nicht m√∂glich.");
                return;
            }
            const playersRef = getPlayerCollectionRef();
            
            try {
                if (playerData.id && state.players.some(p => p.id === playerData.id)) {
                    // Update existing player
                    const playerDocRef = doc(playersRef, playerData.id);
                    await updateDoc(playerDocRef, {
                        name: playerData.name,
                        number: parseInt(playerData.number) || null,
                        position: playerData.position,
                        stats: playerData.stats
                    });
                    showStatMessage('Spieler erfolgreich aktualisiert.', 'info');
                } else {
                    // Add new player
                    // Ensure the number is unique before adding, but Firestore query is complex.
                    // Simple check:
                    if (state.players.some(p => p.number == playerData.number)) {
                         showStatMessage(`Trikotnummer ${playerData.number} bereits vergeben.`, 'error');
                         return;
                    }
                    await addDoc(playersRef, {
                        name: playerData.name,
                        number: parseInt(playerData.number) || null,
                        position: playerData.position,
                        stats: playerData.stats,
                        createdAt: new Date().toISOString()
                    });
                    showStatMessage('Neuer Spieler erfolgreich hinzugef√ºgt.', 'info');
                }
                closeModal();
            } catch (e) {
                console.error("Fehler beim Speichern des Spielers: ", e);
                showStatMessage('Fehler beim Speichern. Pr√ºfen Sie die Konsole.', 'error');
            }
        }

        async function deletePlayer(playerId) {
            if (!isAuthReady || !userId) return;
            
            // Custom Confirmation Modal - replacing window.confirm
            const confirmDelete = await showCustomModal(
                'Spieler L√∂schen',
                'Sind Sie sicher, dass Sie diesen Spieler unwiderruflich l√∂schen m√∂chten?',
                'L√∂schen',
                'Abbrechen'
            );

            if (confirmDelete) {
                try {
                    const playersRef = getPlayerCollectionRef();
                    await deleteDoc(doc(playersRef, playerId));
                    closeModal();
                } catch (e) {
                    console.error("Fehler beim L√∂schen des Spielers: ", e);
                    showStatMessage('Fehler beim L√∂schen. Pr√ºfen Sie die Konsole.', 'error');
                }
            }
        }


        // --- UI Rendering ---

        function renderPlayerList() {
            playerListElement.innerHTML = '';

            if (state.players.length === 0) {
                playerListElement.innerHTML = `
                    <div class="text-center p-10">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20v-2m0 2H7m10 0h3m-3 0h3m-3 0h3m-3 0h3m-3 0h3m-3 0h3m-3 0h3m-3 0h3M7 4v2m0 0v2m0 0v2m0 0v2m0 0v2m0 0v2m0 0v2m0 0v2M4 12H2v-2a3 3 0 015.356-1.857M4 12v-2m0 2H2v-2m0 2H2v-2m0 2H2v-2m0 2H2v-2m0 2H2v-2m0 2H2v-2m0 2H2v-2m0 2H2v-2M10 4h5v-2a3 3 0 00-5.356-1.857M10 4v2m0 0v2m0 0v2m0 0v2m0 0v2m0 0v2m0 0v2m0 0v2M14 4h5v-2a3 3 0 00-5.356-1.857M14 4v2m0 0v2m0 0v2m0 0v2m0 0v2m0 0v2m0 0v2m0 0v2M17 4h5v-2a3 3 0 00-5.356-1.857M17 4v2m0 0v2m0 0v2m0 0v2m0 0v2m0 0v2m0 0v2m0 0v2" />
                        </svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900">Keine Spieler im Kader</h3>
                        <p class="mt-1 text-sm text-gray-500">
                            Beginnen Sie mit dem Hinzuf√ºgen des ersten Spielers.
                        </p>
                        <div class="mt-6">
                            <button onclick="openModalForNewPlayer()" type="button" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-full text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                                <svg class="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                                </svg>
                                Neuer Spieler hinzuf√ºgen
                            </button>
                        </div>
                    </div>
                `;
                return;
            }

            state.players.forEach(player => {
                const playerCard = document.createElement('div');
                const GP = player.stats?.GP || 0;
                const PTS = player.stats?.PTS || 0;
                const REB = player.stats?.REB || 0;
                const AST = player.stats?.AST || 0;
                
                playerCard.className = 'player-card bg-white p-4 rounded-xl shadow-lg hover:shadow-xl transition duration-300 cursor-pointer flex items-center space-x-4 border-l-4 border-blue-500';
                playerCard.onclick = () => openModalForPlayer(player.id);
                
                playerCard.innerHTML = `
                    <div class="flex-shrink-0 w-12 h-12 bg-blue-600 text-white rounded-full flex items-center justify-center font-extrabold text-xl shadow-inner">
                        ${player.number || '?'}
                    </div>
                    <div class="flex-grow">
                        <h3 class="text-lg font-bold text-gray-800">${player.name || 'Unbenannter Spieler'}</h3>
                        <p class="text-sm text-gray-500">${player.position || 'Position Unbekannt'}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-semibold text-gray-800">${(GP > 0 ? (PTS / GP).toFixed(1) : 0)} PTS</p>
                        <p class="text-xs text-gray-500">${(GP > 0 ? (REB / GP).toFixed(1) : 0)} REB | ${(GP > 0 ? (AST / GP).toFixed(1) : 0)} AST</p>
                    </div>
                `;
                playerListElement.appendChild(playerCard);
            });
        }

        function renderStatEntry(player) {
            statListElement.innerHTML = '';
            const searchValue = statSearchInput.value.toLowerCase();
            const stats = player.stats || {};

            Object.entries(initialStats)
                .filter(([key, label]) => 
                    label.toLowerCase().includes(searchValue) || key.toLowerCase().includes(searchValue)
                )
                .forEach(([key, label]) => {
                    const value = stats[key] || 0;

                    const statItem = document.createElement('div');
                    statItem.className = 'flex items-center justify-between p-2 hover:bg-gray-50 rounded-lg transition duration-100 border-b last:border-b-0';
                    statItem.innerHTML = `
                        <label for="stat-${key}" class="block text-sm font-medium text-gray-700 w-3/5">${label} (${key})</label>
                        <div class="w-2/5 flex items-center space-x-2">
                            <input 
                                type="number" 
                                id="stat-${key}" 
                                data-stat-key="${key}"
                                value="${value}" 
                                min="0"
                                class="w-full shadow-sm focus:ring-blue-500 focus:border-blue-500 border-gray-300 rounded-md p-2 text-right text-sm"
                                placeholder="0"
                            >
                        </div>
                    `;
                    statListElement.appendChild(statItem);
                });
            
            // Reattach event listener for input changes
            statListElement.querySelectorAll('input[type="number"]').forEach(input => {
                input.addEventListener('input', handleStatChange);
            });
        }
        
        function renderReport(player) {
            if ((player.stats?.GP || 0) === 0) {
                reportContentElement.innerHTML = `
                    <div class="text-center p-10 bg-red-50 rounded-xl">
                        <svg class="mx-auto h-12 w-12 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <h3 class="mt-2 text-lg font-medium text-red-800">Keine Spieldaten vorhanden</h3>
                        <p class="mt-1 text-sm text-red-600">
                            Bitte tragen Sie zuerst Statistiken und mindestens ein Gespieltes Spiel (GP) ein, um den Analysebericht zu generieren.
                        </p>
                    </div>
                `;
                return;
            }
            reportContentElement.innerHTML = calculateAdvancedStats(player);
        }

        function renderModalTabs(player) {
            const tabs = [
                { id: 'entry', label: 'Statistikeingabe' },
                { id: 'report', label: 'Analyse-Bericht' }
            ];

            modalTabContainer.innerHTML = tabs.map(tab => `
                <button 
                    onclick="switchModalTab('${tab.id}')"
                    class="py-3 px-4 text-sm font-medium rounded-t-lg transition duration-150 ease-in-out ${state.currentTab === tab.id 
                        ? 'text-blue-600 border-b-2 border-blue-600 bg-white' 
                        : 'text-gray-500 hover:text-gray-700 hover:bg-gray-50'}"
                >
                    ${tab.label}
                </button>
            `).join('');

            // Show/Hide tab content
            document.getElementById('entry-tab-content').classList.toggle('hidden', state.currentTab !== 'entry');
            document.getElementById('report-tab-content').classList.toggle('hidden', state.currentTab !== 'report');
            
            // Update the content when switching
            if (state.currentTab === 'entry') {
                renderStatEntry(player);
            } else if (state.currentTab === 'report') {
                renderReport(player);
            }
        }


        // --- Event Handlers & Main Logic ---

        window.openModalForNewPlayer = function() {
            state.currentPlayer = { name: '', number: '', position: '', stats: {} };
            modalTitleElement.textContent = 'Neuen Spieler hinzuf√ºgen';
            playerForm.querySelector('#player-id').value = '';
            playerForm.querySelector('#player-name').value = '';
            playerForm.querySelector('#player-number').value = '';
            playerForm.querySelector('#player-position').value = '';
            document.getElementById('delete-button').classList.add('hidden');
            
            state.currentTab = 'entry';
            renderModalTabs(state.currentPlayer);
            modalElement.classList.remove('hidden');
        }

        window.openModalForPlayer = function(id) {
            const player = state.players.find(p => p.id === id);
            if (!player) return;

            state.currentPlayer = JSON.parse(JSON.stringify(player)); // Deep copy for editing
            modalTitleElement.textContent = `Spieler ${player.number || '?'} - ${player.name || 'Unbekannt'}`;
            playerForm.querySelector('#player-id').value = player.id;
            playerForm.querySelector('#player-name').value = player.name || '';
            playerForm.querySelector('#player-number').value = player.number || '';
            playerForm.querySelector('#player-position').value = player.position || '';
            
            document.getElementById('delete-button').classList.remove('hidden');

            state.currentTab = 'entry';
            renderModalTabs(state.currentPlayer);
            modalElement.classList.remove('hidden');
        }

        window.closeModal = function() {
            modalElement.classList.add('hidden');
            state.currentPlayer = null;
            statSearchInput.value = ''; // Clear search when closing
            statMessage.textContent = '';
        }

        window.switchModalTab = function(tabId) {
            state.currentTab = tabId;
            if (state.currentPlayer) {
                renderModalTabs(state.currentPlayer);
            }
        }

        function handleStatChange(event) {
            if (!state.currentPlayer) return;
            const key = event.target.dataset.statKey;
            let value = parseInt(event.target.value) || 0;
            if (value < 0) value = 0; // Stats cannot be negative
            
            state.currentPlayer.stats = { ...state.currentPlayer.stats, [key]: value };
        }

        playerForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Update player metadata from form fields
            state.currentPlayer.name = playerForm.querySelector('#player-name').value.trim();
            state.currentPlayer.number = parseInt(playerForm.querySelector('#player-number').value) || null;
            state.currentPlayer.position = playerForm.querySelector('#player-position').value.trim();

            if (!state.currentPlayer.name || !state.currentPlayer.number) {
                showStatMessage('Bitte geben Sie einen Namen und eine Trikotnummer ein.', 'error');
                return;
            }

            savePlayer(state.currentPlayer);
        });
        
        document.getElementById('delete-button').addEventListener('click', () => {
            if (state.currentPlayer && state.currentPlayer.id) {
                deletePlayer(state.currentPlayer.id);
            }
        });

        statSearchInput.addEventListener('input', () => {
            if (state.currentPlayer && state.currentTab === 'entry') {
                renderStatEntry(state.currentPlayer);
            }
        });
        
        // Custom Confirmation Modal Implementation
        // This replaces the forbidden window.confirm()
        const customModal = document.createElement('div');
        customModal.className = 'fixed inset-0 z-50 hidden items-center justify-center modal-bg';
        document.body.appendChild(customModal);

        function showCustomModal(title, message, confirmText, cancelText) {
            return new Promise((resolve) => {
                customModal.innerHTML = `
                    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform transition-all">
                        <h3 class="text-lg font-bold text-gray-900 border-b pb-2">${title}</h3>
                        <p class="mt-4 text-sm text-gray-700">${message}</p>
                        <div class="mt-6 flex justify-end space-x-3">
                            <button id="cancel-btn" type="button" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition">
                                ${cancelText}
                            </button>
                            <button id="confirm-btn" type="button" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 transition shadow-md">
                                ${confirmText}
                            </button>
                        </div>
                    </div>
                `;
                customModal.classList.remove('hidden');
                customModal.classList.add('flex');

                document.getElementById('confirm-btn').onclick = () => {
                    customModal.classList.add('hidden');
                    customModal.classList.remove('flex');
                    resolve(true);
                };

                document.getElementById('cancel-btn').onclick = () => {
                    customModal.classList.add('hidden');
                    customModal.classList.remove('flex');
                    resolve(false);
                };
            });
        }
        
        // Initialize everything
        window.onload = initFirebase;

    </script>
</head>
<body class="bg-gray-100 min-h-screen">

    <div class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Header -->
        <header class="flex justify-between items-center mb-6 bg-white p-6 rounded-xl shadow-md">
            <h1 class="text-3xl font-extrabold text-blue-700">üèÄ Kaderanalyse</h1>
            <button onclick="openModalForNewPlayer()" id="add-player-btn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-full shadow-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transform transition hover:scale-105">
                <svg class="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
                Spieler hinzuf√ºgen
            </button>
        </header>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="text-center p-4 text-sm text-gray-500 mb-4 bg-yellow-100 rounded-lg">
            Initialisiere Anwendung...
        </div>

        <!-- Player List -->
        <div id="player-list" class="space-y-4">
            <!-- Player cards will be rendered here -->
        </div>

    </div>

    <!-- Player Modal (Popup) -->
    <div id="player-modal" class="fixed inset-0 z-40 hidden flex items-center justify-center modal-bg overflow-y-auto" role="dialog" aria-modal="true" onclick="if(event.target.id === 'player-modal') closeModal()">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-2xl transform transition-all my-8 mx-4">
            
            <!-- Modal Header -->
            <div class="flex justify-between items-center border-b pb-4 mb-4">
                <h2 id="modal-title" class="text-2xl font-bold text-gray-800">Spieler Details</h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>

            <!-- Tab Container -->
            <div class="border-b mb-4">
                <div id="modal-tab-container" class="flex space-x-4 -mb-px">
                    <!-- Tabs rendered by JS -->
                </div>
            </div>

            <!-- Tab Content: Statistikeingabe -->
            <div id="entry-tab-content">
                <form id="player-form" class="space-y-4">
                    <input type="hidden" id="player-id">
                    
                    <!-- Player Info Fields -->
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label for="player-name" class="block text-sm font-medium text-gray-700">Spielername</label>
                            <input type="text" id="player-name" required class="mt-1 block w-full shadow-sm focus:ring-blue-500 focus:border-blue-500 border-gray-300 rounded-md p-2">
                        </div>
                        <div>
                            <label for="player-number" class="block text-sm font-medium text-gray-700">Trikotnummer</label>
                            <input type="number" id="player-number" min="0" required class="mt-1 block w-full shadow-sm focus:ring-blue-500 focus:border-blue-500 border-gray-300 rounded-md p-2">
                        </div>
                        <div>
                            <label for="player-position" class="block text-sm font-medium text-gray-700">Position</label>
                            <input type="text" id="player-position" class="mt-1 block w-full shadow-sm focus:ring-blue-500 focus:border-blue-500 border-gray-300 rounded-md p-2" placeholder="z.B. Guard, Center">
                        </div>
                    </div>

                    <!-- Stat Entry Header and Search -->
                    <div class="pt-4 border-t">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">Statistiken akkumulieren</h3>
                        <input 
                            type="text" 
                            id="stat-search" 
                            placeholder="Statistik suchen (z.B. Dreier, Assists, FTM)" 
                            class="mb-3 block w-full shadow-sm focus:ring-blue-500 focus:border-blue-500 border-gray-300 rounded-full p-3 bg-gray-50"
                        >
                    </div>

                    <!-- Stat List Container -->
                    <div id="stat-list" class="stat-list h-72 overflow-y-auto pr-2 bg-gray-50 p-3 rounded-lg border">
                        <!-- Stat items rendered by JS (renderStatEntry) -->
                    </div>

                    <p id="stat-message" class="text-center font-medium"></p>
                    
                    <!-- Form Actions -->
                    <div class="flex justify-between pt-4 border-t">
                        <button id="delete-button" type="button" class="px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-white bg-red-600 hover:bg-red-700 shadow-md transition transform hover:scale-105">
                            Spieler l√∂schen
                        </button>
                        <button type="submit" class="px-6 py-2 border border-transparent text-sm font-medium rounded-lg text-white bg-green-600 hover:bg-green-700 shadow-lg transition transform hover:scale-105">
                            Speichern & Schlie√üen
                        </button>
                    </div>
                </form>
            </div>

            <!-- Tab Content: Analyse-Bericht -->
            <div id="report-tab-content" class="hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Analyse-Bericht</h3>
                <div id="report-content" class="min-h-72 bg-gray-50 p-4 rounded-lg border">
                    <!-- Report content rendered by JS (renderReport) -->
                    <p class="text-gray-500 text-center py-10">Generiere Bericht...</p>
                </div>
            </div>

        </div>
    </div>

</body>
</html>
